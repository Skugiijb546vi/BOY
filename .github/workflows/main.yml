name: Extract_Audio_From_Telegram_Ultimate
on:
  workflow_dispatch:
    inputs:
      tg_url:
        description: 'Ù„ÛŒÙ†Ú©ÛŒ Ù¾Û†Ø³ØªÛŒ ØªÛÙ„ÛŒÚ¯Ø±Ø§Ù…'
        required: true
      audio_name:
        description: 'Ù†Ø§ÙˆÛŒ ÙØ§ÛŒÙ„Û• Ø¯Û•Ù†Ú¯ÛŒÛŒÛ•Ú©Û•'
        required: true
        default: 'movie_audio.mp3'

jobs:
  extract_and_upload:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ—ï¸ Setup Tools
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y ffmpeg -qq
          python -m pip install -U pip pyrogram tgcrypto huggingface_hub

      - name: â¬‡ï¸ Download Media via Pyrogram
        env:
          TG_API_ID: ${{ secrets.TG_API_ID }}
          TG_API_HASH: ${{ secrets.TG_API_HASH }}
          TG_SESSION: ${{ secrets.TG_SESSION }}
          TG_URL: ${{ github.event.inputs.tg_url }}
        run: |
          python3 -c "
          import os, sys
          from pyrogram import Client
          
          api_id = os.environ.get('TG_API_ID')
          api_hash = os.environ.get('TG_API_HASH')
          session_string = os.environ.get('TG_SESSION', '').strip()
          url = os.environ.get('TG_URL')
          
          parts = url.rstrip('/').split('/')
          if 'c' in parts:
              chat_id = int('-100' + parts[-2])
          else:
              chat_id = parts[-2]
          msg_id = int(parts[-1].split('?')[0])
          
          app = Client('my_account', api_id=int(api_id), api_hash=api_hash, session_string=session_string)
          
          async def main():
              async with app:
                  target_msg = None
                  # Ú¯Û•Ú•Ø§Ù† Ù„Û• Ù…Û•ÙˆØ¯Ø§ÛŒÛ•Ú©ÛŒ ÙØ±Ø§ÙˆØ§Ù†ØªØ± (Ù¡Ù  Ù†Ø§Ù…Û• Ø¨Û† Ù¾ÛØ´ Ùˆ Ù¾Ø§Ø´)
                  print(f'ğŸ” Ø®Û•Ø±ÛŒÚ©ÛŒ Ú¯Û•Ú•Ø§Ù†Ù… Ù„Û• Ø¯Û•ÙˆØ±ÙˆØ¨Û•Ø±ÛŒ Ù†Ø§Ù…Û•ÛŒ {msg_id}...')
                  
                  # Ø³Û•Ø±Û•ØªØ§ Ù¾Ø´Ú©Ù†ÛŒÙ†ÛŒ Ø®ÙˆØ¯ÛŒ Ù†Ø§Ù…Û•Ú©Û•ØŒ Ù¾Ø§Ø´Ø§Ù† Ø¯Û•ÙˆØ±ÙˆØ¨Û•Ø±ÛŒ
                  search_range = [0] + [i for j in range(1, 11) for i in (j, -j)]
                  
                  for offset in search_range:
                      msg = await app.get_messages(chat_id, msg_id + offset)
                      if msg and (msg.video or msg.document or msg.audio or msg.animation):
                          target_msg = msg
                          print(f'âœ… Ù…ÛŒØ¯ÛŒØ§ Ø¯Û†Ø²Ø±Ø§ÛŒÛ•ÙˆÛ• Ù„Û• Ù†Ø§Ù…Û•ÛŒ: {msg_id + offset}')
                          break
                  
                  if not target_msg:
                      print('âŒ Ù‡ÛŒÚ† Ú¤ÛŒØ¯ÛŒÛ† ÛŒØ§Ù† ÙØ§ÛŒÙ„ÛÚ© Ù„Û•Ù… Ù…Û•ÙˆØ¯Ø§ÛŒÛ•Ø¯Ø§ Ù†Û•Ø¯Û†Ø²Ø±Ø§ÛŒÛ•ÙˆÛ•!')
                      sys.exit(1)
                      
                  print('ğŸ“¥ Ø¯Û•Ø³Øª Ø¨Û• Ø¯Ø§Ú¯Ø±ØªÙ† Ø¯Û•Ú©Û•Ù…...')
                  # Ø¯Ø§Ú¯Ø±ØªÙ†ÛŒ ÙØ§ÛŒÙ„Û•Ú©Û• Ø¨Û•Ø¨Û Ú¯ÙˆÛØ¯Ø§Ù†Û• Ø¬Û†Ø±Û•Ú©Û•ÛŒ
                  path = await app.download_media(target_msg, file_name='main_media')
                  # Ú¯Û†Ú•ÛŒÙ†ÛŒ Ù†Ø§ÙˆÛŒ Ù‡Û•Ø±Ú†ÛŒ Ø¯Ø§Ø¨Û•Ø²ÛŒÙˆÛ• Ø¨Û† Ù†Ø§ÙˆÛÚ©ÛŒ Ø¬ÛÚ¯ÛŒØ±
                  if os.path.exists(path):
                      os.rename(path, 'input_file')
                      print(f'âœ… ÙØ§ÛŒÙ„Û•Ú©Û• Ø¦Ø§Ù…Ø§Ø¯Û•ÛŒÛ• Ø¨Û† Ù¾Ø±Û†Ø³ÛØ³.')
          
          app.run(main())
          "

      - name: ğŸµ Extract Audio (Safe Mode)
        run: |
          echo "ğŸ”Š Ø¬ÛŒØ§Ú©Ø±Ø¯Ù†Û•ÙˆÛ•ÛŒ Ø¯Û•Ù†Ú¯..."
          # Ø¦Û•Ù… ÙÛ•Ø±Ù…Ø§Ù†Û• Ù‡Û•ÙˆÚµ Ø¯Û•Ø¯Ø§Øª Ø¯Û•Ù†Ú¯ Ù„Û• Ù‡Û•Ø± ÙØ§ÛŒÙ„ÛÚ© Ø¯Û•Ø±Ø¨Ù‡ÛÙ†ÛØª ØªÛ•Ù†Ø§Ù†Û•Øª Ø¦Û•Ú¯Û•Ø± ØªÛ•Ù†Ù‡Ø§ Ú¤ÛŒØ¯ÛŒÛ†Ø´ Ø¨ÛØª
          ffmpeg -i input_file -vn -ar 44100 -ac 2 -ab 192k -f mp3 "${{ github.event.inputs.audio_name }}" || ffmpeg -i input_file "${{ github.event.inputs.audio_name }}"
          echo "âœ… ØªÛ•ÙˆØ§Ùˆ Ø¨ÙˆÙˆ."

      - name: ğŸš€ Upload to Hugging Face
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          python3 -c "
          import os
          from huggingface_hub import HfApi
          api = HfApi()
          audio_file = '${{ github.event.inputs.audio_name }}'
          if os.path.exists(audio_file):
              api.upload_file(
                  path_or_fileobj=audio_file,
                  path_in_repo=audio_file,
                  repo_id='Sarkoakram/sarko761',
                  repo_type='dataset',
                  token=os.getenv('HF_TOKEN')
              )
              print('ğŸš€ Ù†Ø§Ø±Ø¯Ù† Ø¨Û† Hugging Face Ø³Û•Ø±Ú©Û•ÙˆØªÙˆÙˆ Ø¨ÙˆÙˆ!')
          else:
              print('âŒ ÙØ§ÛŒÙ„Û•Ú©Û• Ø¯Ø±ÙˆØ³Øª Ù†Û•Ø¨ÙˆÙˆÛ•ØŒ Ù¾Ø´Ú©Ù†ÛŒÙ†ÛŒ FFmpeg Ø¨Ú©Û•.')
          "
