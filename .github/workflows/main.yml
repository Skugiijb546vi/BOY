name: Extract_Audio_From_Telegram_Private
on:
  workflow_dispatch:
    inputs:
      tg_url:
        description: 'Ù„ÛŒÙ†Ú©ÛŒ Ù¾Û†Ø³ØªÛŒ ØªÛÙ„ÛŒÚ¯Ø±Ø§Ù…'
        required: true
      audio_name:
        description: 'Ù†Ø§ÙˆÛŒ ÙØ§ÛŒÙ„Û• Ø¯Û•Ù†Ú¯ÛŒÛŒÛ•Ú©Û•'
        required: true
        default: 'movie_audio.mp3'

jobs:
  extract_and_upload:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ—ï¸ Setup Tools
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y ffmpeg -qq
          python -m pip install -U pip pyrogram tgcrypto huggingface_hub

      - name: â¬‡ï¸ Download Video via Pyrogram
        env:
          TG_API_ID: ${{ secrets.TG_API_ID }}
          TG_API_HASH: ${{ secrets.TG_API_HASH }}
          TG_SESSION: ${{ secrets.TG_SESSION }}
          TG_URL: ${{ github.event.inputs.tg_url }}
        run: |
          python3 -c "
          import os, sys
          from pyrogram import Client
          
          api_id = os.environ.get('TG_API_ID')
          api_hash = os.environ.get('TG_API_HASH')
          session_string = os.environ.get('TG_SESSION', '').strip()
          url = os.environ.get('TG_URL')
          
          parts = url.rstrip('/').split('/')
          if 'c' in parts:
              chat_id = int('-100' + parts[-2])
          else:
              chat_id = parts[-2]
          msg_id = int(parts[-1].split('?')[0])
          
          app = Client('my_account', api_id=int(api_id), api_hash=api_hash, session_string=session_string)
          
          async def main():
              async with app:
                  print(f'ğŸ” Ú¯Û•Ú•Ø§Ù† Ø¨Û† Ù†Ø§Ù…Û•ÛŒ {msg_id}...')
                  msg = await app.get_messages(chat_id, msg_id)
                  
                  # Ø¦Û•Ú¯Û•Ø± Ù¾Û†Ø³ØªÛ•Ú©Û• Ù‡ÛŒÚ†ÛŒ ØªÛØ¯Ø§ Ù†Û•Ø¨ÙˆÙˆØŒ Ø³Û•ÛŒØ±ÛŒ Ø¯Û•ÙˆØ±ÙˆØ¨Û•Ø± Ø¯Û•Ú©Ø§Øª
                  if not msg or not (msg.video or msg.document):
                      print('âš ï¸ Ú¯Û•Ú•Ø§Ù† Ù„Û• Ù†Ø§Ù…Û•Ú©Ø§Ù†ÛŒ ØªØ± Ø¨Û† Ø¯Û†Ø²ÛŒÙ†Û•ÙˆÛ•ÛŒ Ú¤ÛŒØ¯ÛŒÛ†...')
                      for offset in [-1, 1, -2, 2]:
                          temp_msg = await app.get_messages(chat_id, msg_id + offset)
                          if temp_msg and (temp_msg.video or temp_msg.document):
                              msg = temp_msg
                              break
                  
                  if not msg or not (msg.video or msg.document):
                      print('âŒ Ù‡ÛŒÚ† Ú¤ÛŒØ¯ÛŒÛ†ÛŒÛ•Ú© Ù†Û•Ø¯Û†Ø²Ø±Ø§ÛŒÛ•ÙˆÛ•!')
                      sys.exit(1)
                      
                  print('ğŸ“¥ Ø®Û•Ø±ÛŒÚ©ÛŒ Ø¯Ø§Ú¯Ø±ØªÙ†ÛŒ Ú¤ÛŒØ¯ÛŒÛ†Ú©Û•ÛŒÛ•...')
                  # Ù„ÛØ±Û•Ø¯Ø§ Ø¯ÚµÙ†ÛŒØ§ Ø¯Û•Ø¨ÛŒÙ†Û•ÙˆÛ• Ú©Û• ØªÛ•Ù†Ù‡Ø§ Ù…ÛŒØ¯ÛŒØ§Ú©Û• Ø¯Ø§Ø¯Û•Ú¯Ø±ÛØª Ù†Û•Ú© ÙˆÛÙ†Û•ÛŒ Ø¨Û•Ø±Ú¯
                  path = await app.download_media(msg, file_name='main_video.mp4')
                  print(f'âœ… Ø¯Ø§Ú¯ÛŒØ±Ø§ Ù„Û• Ø´ÙˆÛÙ†ÛŒ: {path}')
          
          app.run(main())
          "

      - name: ğŸµ Extract Audio
        run: |
          echo "Ø®Û•Ø±ÛŒÚ©ÛŒ Ø¬ÛŒØ§Ú©Ø±Ø¯Ù†Û•ÙˆÛ•ÛŒ Ø¯Û•Ù†Ú¯..."
          # Ø¨Û•Ú©Ø§Ø±Ù‡ÛÙ†Ø§Ù†ÛŒ ÙÙ„ØªÛ•Ø±ÛŒ Ø²ÛŒØ§ØªØ± Ø¨Û† Ø¦Û•ÙˆÛ•ÛŒ Ø¦Û•Ú¯Û•Ø± ÙØ§ÛŒÙ„Û•Ú©Û• Ú©ÛØ´Û•Ø´ÛŒ Ù‡Û•Ø¨ÙˆÙˆ Ù‡Û•Ø± Ø¯Û•Ù†Ú¯Û•Ú©Û• Ø¯Û•Ø±Ø¨Ù‡ÛÙ†ÛØª
          ffmpeg -i main_video.mp4 -vn -acodec libmp3lame -q:a 2 "${{ github.event.inputs.audio_name }}"
          echo "âœ… Ø¯Û•Ù†Ú¯Û•Ú©Û• Ø¦Ø§Ù…Ø§Ø¯Û•ÛŒÛ•."

      - name: ğŸš€ Upload to Hugging Face
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          python3 -c "
          import os
          from huggingface_hub import HfApi
          api = HfApi()
          audio_file = '${{ github.event.inputs.audio_name }}'
          if os.path.exists(audio_file):
              api.upload_file(
                  path_or_fileobj=audio_file,
                  path_in_repo=audio_file,
                  repo_id='Sarkoakram/sarko761',
                  repo_type='dataset',
                  token=os.getenv('HF_TOKEN')
              )
              print('âœ… ÙØ§ÛŒÙ„Û•Ú©Û• Ù†ÛØ±Ø¯Ø±Ø§!')
          else:
              print('âŒ ÙØ§ÛŒÙ„Û•Ú©Û• Ø¯Ø±ÙˆØ³Øª Ù†Û•Ø¨ÙˆÙˆÛ•!')
          "
