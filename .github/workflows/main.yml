name: Extract_Audio_From_Telegram_Final_Fix
on:
  workflow_dispatch:
    inputs:
      tg_url:
        description: 'Ù„ÛŒÙ†Ú©ÛŒ Ù¾Û†Ø³ØªÛŒ ØªÛÙ„ÛŒÚ¯Ø±Ø§Ù…'
        required: true
      audio_name:
        description: 'Ù†Ø§ÙˆÛŒ ÙØ§ÛŒÙ„Û• Ø¯Û•Ù†Ú¯ÛŒÛŒÛ•Ú©Û•'
        required: true
        default: 'movie_audio.mp3'

jobs:
  extract_and_upload:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ—ï¸ Setup Tools
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y ffmpeg -qq
          python -m pip install -U pip pyrogram tgcrypto huggingface_hub

      - name: â¬‡ï¸ Download Media via Pyrogram
        env:
          TG_API_ID: ${{ secrets.TG_API_ID }}
          TG_API_HASH: ${{ secrets.TG_API_HASH }}
          TG_SESSION: ${{ secrets.TG_SESSION }}
          TG_URL: ${{ github.event.inputs.tg_url }}
        run: |
          python3 -c "
          import os, sys, asyncio
          from pyrogram import Client
          
          async def main():
              api_id = int(os.environ.get('TG_API_ID'))
              api_hash = os.environ.get('TG_API_HASH')
              session_string = os.environ.get('TG_SESSION', '').strip()
              url = os.environ.get('TG_URL').rstrip('/')
              
              # Ø´ÛŒÚ©Ø±Ø¯Ù†Û•ÙˆÛ•ÛŒ Ù„ÛŒÙ†Ú©Û•Ú©Û• Ø¨Û• Ø´ÛÙˆÛ•ÛŒÛ•Ú©ÛŒ Ø³Û•Ù„Ø§Ù…Û•Øª
              parts = url.split('/')
              msg_id = int(parts[-1].split('?')[0])
              chat_id = parts[-2]
              
              # Ø¦Û•Ú¯Û•Ø± Ú©Û•Ù†Ø§ÚµÛ•Ú©Û• Ù¾Ú•Ø§ÛŒÚ¤ÛØª Ø¨ÙˆÙˆ (Ø¨Û•Ù¾ÛŒØªÛŒ c Ø¯Û•Ø³ØªÙ¾ÛØ¯Û•Ú©Ø§Øª)
              if chat_id == 'c':
                  chat_id = int('-100' + parts[-3])
              
              app = Client('my_account', api_id=api_id, api_hash=api_hash, session_string=session_string)
              
              async with app:
                  print(f'ğŸ” Ú¯Û•Ú•Ø§Ù† Ø¨Û† Ù†Ø§Ù…Û•ÛŒ {msg_id} Ù„Û• {chat_id}...')
                  target_msg = None
                  
                  # Ú¯Û•Ú•Ø§Ù† Ù„Û• Ù…Û•ÙˆØ¯Ø§ÛŒÛ•Ú©ÛŒ ÙØ±Ø§ÙˆØ§Ù† (Ù¢Ù  Ù†Ø§Ù…Û• Ø¨Û† Ù¾ÛØ´ Ùˆ Ù¾Ø§Ø´)
                  for offset in [0, -1, 1, -2, 2, -3, 3, -4, 4, -5, 5]:
                      try:
                          msg = await app.get_messages(chat_id, msg_id + offset)
                          if msg and (msg.video or msg.document or msg.audio):
                              target_msg = msg
                              print(f'âœ… Ù…ÛŒØ¯ÛŒØ§ Ø¯Û†Ø²Ø±Ø§ÛŒÛ•ÙˆÛ• Ù„Û• Ø¦Ø§ÛŒØ¯ÛŒ: {msg_id + offset}')
                              break
                      except Exception as e:
                          continue
                  
                  if not target_msg:
                      print('âŒ Ù‡ÛŒÚ† Ú¤ÛŒØ¯ÛŒÛ† ÛŒØ§Ù† ÙØ§ÛŒÙ„ÛÚ© Ù†Û•Ø¯Û†Ø²Ø±Ø§ÛŒÛ•ÙˆÛ•!')
                      sys.exit(1)
                      
                  print('ğŸ“¥ Ø¯Û•Ø³Øª Ø¨Û• Ø¯Ø§Ú¯Ø±ØªÙ† Ø¯Û•Ú©Û•Ù…...')
                  path = await app.download_media(target_msg, file_name='input_file')
                  print(f'âœ… Ø¯Ø§Ú¯ÛŒØ±Ø§: {path}')
                  
                  # Ø¦Û•Ú¯Û•Ø± ÙØ§ÛŒÙ„Û•Ú©Û• Ù†Ø§ÙˆÛ•Ú©Û•ÛŒ Ø¬ÛŒØ§ÙˆØ§Ø² Ø¨ÙˆÙˆØŒ Ú•ÛÚ©ÛŒ Ø¯Û•Ø®Û•ÛŒÙ†Û•ÙˆÛ•
                  if os.path.exists(path) and path != 'input_file':
                      os.rename(path, 'input_file')
          
          asyncio.run(main())
          "

      - name: ğŸµ Extract Audio
        run: |
          echo "ğŸ”Š Ø¬ÛŒØ§Ú©Ø±Ø¯Ù†Û•ÙˆÛ•ÛŒ Ø¯Û•Ù†Ú¯..."
          # Ø¨Û•Ú©Ø§Ø±Ù‡ÛÙ†Ø§Ù†ÛŒ ÙÛ†Ø±Ù…Ø§ØªÛÚ©ÛŒ Ù¾Ø§Ø±ÛØ²Ø±Ø§Ùˆ Ø¨Û† FFmpeg
          ffmpeg -i input_file -vn -q:a 2 "${{ github.event.inputs.audio_name }}"
          echo "âœ… ØªÛ•ÙˆØ§Ùˆ Ø¨ÙˆÙˆ."

      - name: ğŸš€ Upload to Hugging Face
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          python3 -c "
          import os
          from huggingface_hub import HfApi
          api = HfApi()
          audio_file = '${{ github.event.inputs.audio_name }}'
          if os.path.exists(audio_file):
              api.upload_file(
                  path_or_fileobj=audio_file,
                  path_in_repo=audio_file,
                  repo_id='Sarkoakram/sarko761',
                  repo_type='dataset',
                  token=os.getenv('HF_TOKEN')
              )
              print('ğŸš€ Ù†Ø§Ø±Ø¯Ù† Ø³Û•Ø±Ú©Û•ÙˆØªÙˆÙˆ Ø¨ÙˆÙˆ!')
          "
